# MapOMOP API Docker Compose
# Standalone configuration for MapOMOP API service

version: '3.8'

services:
  mapomop:
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
    platform: linux/amd64
    container_name: mapomop-api
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - ES_HOST=elasticsearch
      - ES_PORT=9200
      - ES_USERNAME=elastic
      - ES_PASSWORD=snomed
      - SAPBERT_URL=http://sapbert:8000
      - LOCAL_LLM_MODEL=qwen
      - LOCAL_LLM_PATH=/app/llm-models
      - SCORING_MODE=local_llm
      - CONFIDENCE_THRESHOLD=0.5
    volumes:
      - ./logs:/app/logs
      # 로컬 sLLM 모델 마운트
      - ../volumes/llm-weights:/app/llm-models:ro
    # GPU support for CUDA
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - mapomop-network
    depends_on:
      - elasticsearch

  # Elasticsearch (for standalone testing)
  elasticsearch:
    image: elasticsearch:8.18.0
    platform: linux/amd64
    container_name: elasticsearch
    environment:
      - node.name=elasticsearch
      - discovery.type=single-node
      - ELASTIC_PASSWORD=snomed
      - bootstrap.memory_lock=true
      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - es-data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200 | grep -q 'cluster_name'"]
      interval: 10s
      timeout: 10s
      retries: 120
    networks:
      - mapomop-network

volumes:
  es-data:
    driver: local

networks:
  mapomop-network:
    driver: bridge
